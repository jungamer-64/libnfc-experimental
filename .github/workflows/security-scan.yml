name: Security Scan

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  semgrep:
    name: Semgrep Static Analysis
    runs-on: ubuntu-latest
    container:
      image: returntocorp/semgrep

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep
        run: |
          semgrep scan --config=auto --error --json --output=semgrep-results.json
          semgrep scan --config=auto --error
        continue-on-error: true

      - name: Upload Semgrep results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: semgrep-results
          path: semgrep-results.json

  trivy:
    name: Trivy Vulnerability Scanner
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Trivy filesystem scan (table format)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'

  codacy:
    name: Codacy Analysis CLI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Codacy Analysis CLI
        uses: codacy/codacy-analysis-cli-action@master
        with:
          output: codacy-results.sarif
          format: sarif
          # Use default tools (ESLint, PMD, etc.)
          max-allowed-issues: 2147483647
        continue-on-error: true

      - name: Upload Codacy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: codacy-results.sarif

  lizard-complexity:
    name: Code Complexity Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Lizard
        run: pip install lizard

      - name: Run Lizard complexity analysis
        run: |
          echo "## Code Complexity Report" > complexity-report.md
          echo "" >> complexity-report.md
          echo "Functions with CCN > 15:" >> complexity-report.md
          echo '```' >> complexity-report.md
          lizard -l c -C 15 -w libnfc/ examples/ utils/ 2>/dev/null || true
          lizard -l c -C 15 -w libnfc/ examples/ utils/ 2>/dev/null >> complexity-report.md || true
          echo '```' >> complexity-report.md
        continue-on-error: true

      - name: Upload complexity report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: complexity-report
          path: complexity-report.md

  build-security-test:
    name: Build with Security Flags
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential libusb-dev libpcsclite-dev

      - name: Configure with security flags
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..

      - name: Build
        run: |
          cd build
          make -j$(nproc)

      - name: Run tests
        run: |
          cd build
          # Run any available tests
          ctest --output-on-failure || echo "No tests configured"

  summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [semgrep, trivy, codacy, lizard-complexity, build-security-test]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "- Semgrep: ${{ needs.semgrep.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Trivy: ${{ needs.trivy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Codacy: ${{ needs.codacy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Complexity Analysis: ${{ needs.lizard-complexity.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build Test: ${{ needs.build-security-test.result }}" >> $GITHUB_STEP_SUMMARY
